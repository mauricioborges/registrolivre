task bringUpLocalAppServer(type: Exec) {
    commandLine "vagrant", "up", "--no-provision"
    commandLine "sh", "-c", "ssh-keyscan 192.168.33.71 >> ~/.ssh/known_hosts"
}

task createRegisterKeysLocalAppServer(type: Exec){
    commandLine "sh", "scripts/provision/create-register-keys.sh"
}

task provisionLocalAppServer(type: Exec) {
    commandLine "vagrant", "provision"
}

task destroyLocalAppServer(type: Exec) {
    commandLine "vagrant", "destroy", "--force"
    commandLine "sh", "-c", "ssh-keygen -R 192.168.33.71"
}

task statusLocalAppServer(type: Exec) {
    commandLine "vagrant", "status"
}

task createEnvironmentVariables(type: Exec){
    commandLine "sh", "scripts/provision/create-environment-variables.sh"
}

task runNPMInstallLocalAppServer(type: Exec) {
    commandLine "npm",  "install"
}

task deployLocalAppServer(type: Exec) {
    dependsOn runNPMInstallLocalAppServer
    commandLine "sh", "scripts/deploy/local/install.sh"
}

task provisionProductionAppServer(type: Exec) {
    commandLine "sh", "scripts/provision/production/provision-to-aws.sh"
}

task deployProductionAppServer(type: Exec) {
    commandLine "sh", "scripts/deploy/production/install.sh"
}

task createVirtualMachine {
    dependsOn destroyLocalAppServer
    dependsOn bringUpLocalAppServer
    dependsOn createRegisterKeysLocalAppServer
    dependsOn provisionLocalAppServer
    dependsOn(":infrastructure/database:createLocalDatabase")
    dependsOn createEnvironmentVariables
    dependsOn deployLocalAppServer
}
bringUpLocalAppServer.mustRunAfter(destroyLocalAppServer)
createRegisterKeysLocalAppServer.mustRunAfter(bringUpLocalAppServer)
provisionLocalAppServer.mustRunAfter(createRegisterKeysLocalAppServer)
deployLocalAppServer.mustRunAfter(createEnvironmentVariables)
createEnvironmentVariables.mustRunAfter(":infrastructure/database:createLocalDatabase")
